<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务列表 - 甘特图项目管理</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="./task-list.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="task-list-container">
        <div class="task-list-header">
            <h1 class="task-list-title">
                <i class="fas fa-tasks"></i>
                任务列表
            </h1>
            <a href="index.html" class="back-to-gantt" title="返回甘特图视图">
                <i class="fas fa-arrow-left"></i> 返回甘特图
            </a>
        </div>
        
        <div class="table-responsive">
            <table class="task-table" role="grid" aria-label="任务列表">
                <thead>
                    <tr>
                        <th scope="col" role="columnheader">任务名称</th>
                        <th scope="col" role="columnheader">开始日期</th>
                        <th scope="col" role="columnheader">结束日期</th>
                        <th scope="col" role="columnheader">进度</th>
                        <th scope="col" role="columnheader">操作</th>
                    </tr>
                </thead>
                <tbody id="taskListBody">
                    <!-- 任务列表将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>

        <!-- 添加任务按钮 -->
        <div class="task-actions">
            <button id="addTaskBtn" class="add-task-btn" title="添加新任务">
                <i class="fas fa-plus"></i> 添加任务
            </button>
        </div>
    </div>

    <!-- 引入数据库和工具函数 -->
    <script src="./db.js"></script>
    <script src="./date-utils.js"></script>
    <!-- 引入任务列表逻辑 -->
    <script src="./task-list.js"></script>

    <!-- 动画样式 -->
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* Toast 样式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 4px;
            color: white;
            opacity: 0;
            transform: translateY(-20px);
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .toast-success {
            background-color: #27ae60;
        }

        .toast-error {
            background-color: #e74c3c;
        }

        .toast-info {
            background-color: #3498db;
        }

        /* 编辑状态样式 */
        .editing {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .editing td {
            padding: 8px !important;
        }

        .edit-task-name,
        .edit-start-date,
        .edit-end-date,
        .edit-progress {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .edit-task-name:focus,
        .edit-start-date:focus,
        .edit-end-date:focus,
        .edit-progress:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
            outline: none;
        }
    </style>
</body>
</html>
    
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // 创建GanttChart实例（不会初始化canvas相关功能）
                const gantt = new GanttChart();
                
                // 加载任务数据
                gantt.loadTasks().then(() => {
                    const tasks = gantt.tasks;
                    const taskListBody = document.getElementById('taskListBody');
                    
                    if (!taskListBody) {
                        throw new Error('找不到任务列表容器');
                    }
                    
                    // 清空现有内容
                    taskListBody.innerHTML = '';
                    
                    // 渲染任务列表
                    tasks.forEach(task => {
                        const row = document.createElement('tr');
                        
                        // 使用模板字符串提高性能
                        row.innerHTML = `
                            <td class="task-name">${task.name}</td>
                            <td class="task-dates">${task.startDate.toLocaleDateString('zh-CN')}</td>
                            <td class="task-dates">${task.endDate.toLocaleDateString('zh-CN')}</td>
                            <td class="task-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" data-progress="${task.progress || 0}"></div>
                                </div>
                                ${task.progress || 0}%
                            </td>
                            <td>
                                <button class="edit-btn" data-task-id="${task.id}" title="编辑任务">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        `;
                        
                        taskListBody.appendChild(row);
                        
                        // 设置进度条宽度
                        const progressFill = row.querySelector('.progress-fill');
                        if (progressFill) {
                            const progress = task.progress || 0;
                            progressFill.style.width = `${progress}%`;
                        }
                        
                        // 为编辑按钮添加点击事件
                        const editBtn = row.querySelector('.edit-btn');
                        if (editBtn) {
                            editBtn.addEventListener('click', () => {
                                const currentTask = tasks.find(t => t.id === task.id);
                                if (currentTask) {
                                    // 转换为编辑模式
                                    row.innerHTML = `
                                        <td>
                                            <input type="text" class="edit-task-name" value="${currentTask.name}">
                                        </td>
                                        <td>
                                            <input type="date" class="edit-start-date" 
                                                   value="${currentTask.startDate.toISOString().split('T')[0]}">
                                        </td>
                                        <td>
                                            <input type="date" class="edit-end-date" 
                                                   value="${currentTask.endDate.toISOString().split('T')[0]}">
                                        </td>
                                        <td>
                                            <input type="range" class="edit-progress" min="0" max="100" 
                                                   value="${currentTask.progress || 0}">
                                            <span class="progress-value">${currentTask.progress || 0}%</span>
                                        </td>
                                        <td class="edit-actions">
                                            <button class="save-btn" title="保存修改">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button class="cancel-btn" title="取消编辑">
                                                <i class="fas fa-times"></i>
                                            </button>
                                            <button class="delete-btn" title="删除任务">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    `;

                                    // 进度条实时更新显示
                                    const progressInput = row.querySelector('.edit-progress');
                                    const progressValue = row.querySelector('.progress-value');
                                    progressInput.addEventListener('input', () => {
                                        progressValue.textContent = `${progressInput.value}%`;
                                    });

                                    // 保存按钮事件
                                    row.querySelector('.save-btn').addEventListener('click', () => {
                                        currentTask.name = row.querySelector('.edit-task-name').value;
                                        currentTask.startDate = new Date(row.querySelector('.edit-start-date').value);
                                        currentTask.endDate = new Date(row.querySelector('.edit-end-date').value);
                                        currentTask.progress = parseInt(row.querySelector('.edit-progress').value);
                                        
                                        gantt.saveTasks().then(() => {
                                            // 重新渲染行
                                            renderTaskRow(row, currentTask, tasks, gantt);
                                        });
                                    });

                                    // 删除按钮事件
                                    row.querySelector('.delete-btn').addEventListener('click', () => {
                                        gantt.selectedTask = currentTask;
                                        gantt.handleDeleteTask();
                                        row.remove();
                                    });

                                    // 取消按钮事件
                                    row.querySelector('.cancel-btn').addEventListener('click', () => {
                                        renderTaskRow(row, currentTask, tasks, gantt);
                                    });
                                }
                            });
                        }

                        // 渲染任务行的函数
                        function renderTaskRow(row, task, tasks, gantt) {
                            row.innerHTML = `
                                <td class="task-name">${task.name}</td>
                                <td class="task-dates">${task.startDate.toLocaleDateString('zh-CN')}</td>
                                <td class="task-dates">${task.endDate.toLocaleDateString('zh-CN')}</td>
                                <td class="task-progress">
                                    <div class="progress-bar">
                                        <div class="progress-fill" data-progress="${task.progress || 0}"></div>
                                    </div>
                                    ${task.progress || 0}%
                                </td>
                                <td>
                                    <button class="edit-btn" data-task-id="${task.id}" title="编辑任务">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            `;

                            // 设置进度条宽度
                            const progressFill = row.querySelector('.progress-fill');
                            if (progressFill) {
                                const progress = task.progress || 0;
                                progressFill.style.width = `${progress}%`;
                            }
                            
                            // 重新绑定编辑事件
                            const editBtn = row.querySelector('.edit-btn');
                            if (editBtn) {
                            editBtn.addEventListener('click', () => {
                                const currentTask = tasks.find(t => t.id === task.id);
                                if (currentTask) {
                                        // 转换为编辑模式
                                        row.innerHTML = `
                                            <td>
                                                <input type="text" class="edit-task-name" value="${task.name}">
                                            </td>
                                            <td>
                                                <input type="date" class="edit-start-date" 
                                                       value="${task.startDate.toISOString().split('T')[0]}">
                                            </td>
                                            <td>
                                                <input type="date" class="edit-end-date" 
                                                       value="${task.endDate.toISOString().split('T')[0]}">
                                            </td>
                                            <td>
                                                <input type="range" class="edit-progress" min="0" max="100" 
                                                       value="${task.progress || 0}">
                                                <span class="progress-value">${task.progress || 0}%</span>
                                            </td>
                                            <td class="edit-actions">
                                                <button class="save-btn" title="保存修改">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button class="cancel-btn" title="取消编辑">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </td>
                                        `;

                                        // 进度条实时更新显示
                                        const progressInput = row.querySelector('.edit-progress');
                                        const progressValue = row.querySelector('.progress-value');
                                        progressInput.addEventListener('input', () => {
                                            progressValue.textContent = `${progressInput.value}%`;
                                        });

                                        // 保存按钮事件
                                        row.querySelector('.save-btn').addEventListener('click', () => {
                                            task.name = row.querySelector('.edit-task-name').value;
                                            task.startDate = new Date(row.querySelector('.edit-start-date').value);
                                            task.endDate = new Date(row.querySelector('.edit-end-date').value);
                                            task.progress = parseInt(row.querySelector('.edit-progress').value);
                                            
                                            gantt.saveTasks().then(() => {
                                                // 重新渲染行
                                                renderTaskRow(row, task, tasks, gantt);
                                            });
                                        });

                                        // 取消按钮事件
                                        row.querySelector('.cancel-btn').addEventListener('click', () => {
                                            renderTaskRow(row, task, tasks, gantt);
                                        });
                                    }
                                });
                            }
                        }
                    });
                }).catch(error => {
                    throw error;
                });
            } catch (error) {
                console.error('任务列表初始化失败:', error);
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.innerHTML = `
                    <h3>任务列表加载失败</h3>
                    <p>${error.message}</p>
                    <p>请刷新页面或检查控制台获取更多信息</p>
                `;
                document.body.appendChild(errorMsg);
            }
        });
    </script>
</body>
</html>
